<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV Chile</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #1a1a1a;
    --card:     rgba(44,44,44,0.60);
    --card-h:   rgba(56,56,56,0.78);
    --border:   rgba(105,105,105,0.22);
    --border-l: rgba(135,135,135,0.16);
    --text:     #f0f0f0;
    --text2:    #999;
    --muted:    #5a5a5a;
    --accent:   #a0a0a0;
    --accent2:  #cbcbcb;
    --glass:    rgba(28,28,28,0.55);
    --glass2:   rgba(22,22,22,0.90);
    --red:      #e05252;
    --green:    #52e07a;
    --r:        16px;
  }
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; background:var(--bg); font-family:'Nunito Sans',system-ui,sans-serif; color:var(--text); overflow-x:hidden; }

  body::before {
    content:''; position:fixed; inset:0; z-index:9999; pointer-events:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
    opacity:.55;
  }

  .blobs { position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
  .blob  { position:absolute; border-radius:50%; filter:blur(130px); opacity:.065; }
  .b1 { width:650px; height:650px; background:#888; top:-200px; left:-180px; }
  .b2 { width:480px; height:480px; background:#aaa; bottom:-130px; right:-80px; }
  .b3 { width:380px; height:380px; background:#777; top:45%; left:45%; }

  #app { position:relative; z-index:1; min-height:100vh; }
  .view { display:none; }
  .view.active { display:block; }

  nav {
    position:fixed; top:0; left:0; right:0; height:62px; z-index:200;
    background:var(--glass2); backdrop-filter:blur(32px) saturate(1.3);
    -webkit-backdrop-filter:blur(32px) saturate(1.3);
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; padding:0 30px; gap:20px;
  }
  .logo { font-size:19px; font-weight:800; letter-spacing:-.5px; margin-right:auto; display:flex; align-items:center; gap:9px; }
  .logo-icon { width:30px; height:30px; background:rgba(255,255,255,0.07); border:1px solid var(--border-l); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:16px; }
  .logo span { color:var(--text2); font-weight:300; }
  .nav-pill { background:transparent; border:1px solid var(--border); color:var(--text2); padding:6px 17px; border-radius:20px; font-size:13px; font-weight:700; cursor:pointer; transition:.2s; font-family:inherit; }
  .nav-pill:hover, .nav-pill.active { background:rgba(255,255,255,0.08); color:var(--text); border-color:var(--accent); }

  .srch-wrap { position:relative; flex:0 0 250px; }
  .srch { width:100%; background:rgba(255,255,255,0.055); border:1px solid var(--border); border-radius:20px; padding:7px 15px 7px 36px; color:var(--text); font-size:13px; font-family:inherit; outline:none; transition:.2s; }
  .srch::placeholder { color:var(--muted); }
  .srch:focus { background:rgba(255,255,255,0.09); border-color:var(--accent); }
  .srch-ico { position:absolute; left:11px; top:50%; transform:translateY(-50%); color:var(--muted); pointer-events:none; }

  main { padding:82px 30px 50px; }

  .hero { margin-bottom:38px; animation:up .6s ease both; }
  .hero h1 { font-size:clamp(24px,4vw,40px); font-weight:800; letter-spacing:-1px; }
  .hero p  { color:var(--text2); font-size:14px; margin-top:5px; }

  .status-bar { display:flex; align-items:center; gap:12px; margin-bottom:28px; flex-wrap:wrap; animation:up .5s .1s ease both; }
  .sp { background:var(--glass); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px); border:1px solid var(--border-l); border-radius:20px; padding:5px 14px; font-size:12px; font-weight:700; color:var(--text2); display:flex; align-items:center; gap:7px; }
  .dot-r { width:6px; height:6px; background:var(--red); border-radius:50%; box-shadow:0 0 6px var(--red); animation:blink 1.8s ease infinite; }
  .dot-g { width:6px; height:6px; background:var(--green); border-radius:50%; box-shadow:0 0 6px var(--green); }

  .cat-tabs { display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap; animation:up .5s .15s ease both; }
  .cat-tab { background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--text2); padding:6px 17px; border-radius:20px; font-size:13px; font-weight:700; cursor:pointer; transition:.2s; font-family:inherit; }
  .cat-tab:hover { background:rgba(255,255,255,0.08); color:var(--text); }
  .cat-tab.active { background:rgba(255,255,255,0.11); border-color:var(--accent); color:var(--text); }

  .sec-label { font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:1.6px; color:var(--muted); margin-bottom:16px; display:flex; align-items:center; gap:10px; }
  .sec-label::after { content:''; flex:1; height:1px; background:var(--border-l); }

  .ch-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:13px; }
  .ch-card { background:var(--card); backdrop-filter:blur(18px) saturate(1.1); -webkit-backdrop-filter:blur(18px) saturate(1.1); border:1px solid var(--border-l); border-radius:var(--r); padding:20px 14px; cursor:pointer; transition:all .25s cubic-bezier(.4,0,.2,1); display:flex; flex-direction:column; align-items:center; gap:11px; text-align:center; animation:up .5s ease both; }
  .ch-card:hover { background:var(--card-h); border-color:rgba(160,160,160,0.4); transform:translateY(-5px) scale(1.025); box-shadow:0 14px 40px rgba(0,0,0,.55); }
  .ch-card:active { transform:scale(.97); }
  .ch-ico  { width:54px; height:54px; border-radius:13px; display:flex; align-items:center; justify-content:center; font-size:26px; background:rgba(255,255,255,0.055); border:1px solid var(--border); }
  .ch-name { font-size:13px; font-weight:700; }
  .ch-sub  { font-size:11px; color:var(--muted); display:flex; align-items:center; gap:5px; }

  .empty { text-align:center; padding:70px 20px; color:var(--muted); }
  .empty h3 { font-size:16px; font-weight:700; margin-bottom:5px; margin-top:14px; }
  .empty p { font-size:13px; }

  /* PLAYER */
  #player-view { padding-top:62px; }
  .pl-topbar { background:var(--glass2); backdrop-filter:blur(30px); -webkit-backdrop-filter:blur(30px); border-bottom:1px solid var(--border); padding:14px 28px; display:flex; align-items:center; gap:18px; }
  .back-btn { background:rgba(255,255,255,0.07); border:1px solid var(--border); color:var(--text); padding:7px 16px 7px 12px; border-radius:20px; font-size:13px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px; transition:.2s; font-family:inherit; }
  .back-btn:hover { background:rgba(255,255,255,0.12); }
  .pl-ch-name { font-size:16px; font-weight:800; }
  .pl-ch-cat  { font-size:12px; color:var(--text2); margin-top:2px; }
  .live-badge { margin-left:auto; display:flex; align-items:center; gap:7px; font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:1px; color:var(--text2); }
  .pl-box { background:#000; position:relative; width:100%; aspect-ratio:16/9; max-height:calc(100vh - 220px); overflow:hidden; }
  #vid { width:100%; height:100%; display:block; background:#000; }
  .pl-grad { position:absolute; inset:0; background:linear-gradient(to bottom,transparent 55%,rgba(0,0,0,.82)); pointer-events:none; }
  .pl-label { position:absolute; bottom:0; left:0; padding:20px 24px; }
  .pl-label-name { font-size:21px; font-weight:800; letter-spacing:-.4px; text-shadow:0 2px 10px rgba(0,0,0,.8); }
  .pl-label-sub  { font-size:12px; color:rgba(255,255,255,.55); margin-top:3px; }
  .pl-loading { position:absolute; inset:0; background:rgba(0,0,0,.72); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; }
  .spinner { width:38px; height:38px; border:3px solid rgba(255,255,255,.1); border-top-color:rgba(255,255,255,.7); border-radius:50%; animation:spin .8s linear infinite; }
  .pl-error { background:rgba(224,82,82,.1); border:1px solid rgba(224,82,82,.28); color:#e07070; border-radius:10px; padding:12px 16px; font-size:13px; margin:12px 28px; display:none; }
  .pl-error.show { display:block; }
  .related-sec { padding:24px 28px; }

  /* DATA VIEW */
  .dv-wrap { max-width:960px; margin:0 auto; }
  .dv-header { margin-bottom:28px; animation:up .4s ease both; }
  .dv-header h2 { font-size:26px; font-weight:800; letter-spacing:-.5px; }
  .dv-header p  { color:var(--text2); margin-top:5px; font-size:14px; }
  .dv-card { background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid var(--border-l); border-radius:var(--r); overflow:hidden; margin-bottom:18px; animation:up .4s ease both; }
  .dv-head { padding:14px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .dv-head h3 { font-size:14px; font-weight:800; }
  .dv-body { padding:18px 20px; }

  .json-editor { width:100%; min-height:320px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:10px; padding:14px; color:#d4d4d4; font-family:'SF Mono','Fira Code',monospace; font-size:12.5px; line-height:1.7; resize:vertical; outline:none; transition:border-color .2s; tab-size:2; }
  .json-editor:focus { border-color:var(--accent); }
  .json-actions { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }

  .ch-table { width:100%; border-collapse:collapse; }
  .ch-table th { font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:1px; color:var(--muted); padding:0 8px 10px; text-align:left; }
  .ch-table td { padding:5px 8px; vertical-align:middle; }
  .ch-table tr:not(:last-child) td { border-bottom:1px solid var(--border-l); }

  .di { background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:7px; padding:6px 10px; color:var(--text); font-size:13px; font-family:inherit; width:100%; outline:none; transition:.2s; }
  .di:focus { border-color:var(--accent); background:rgba(255,255,255,0.08); }
  .di::placeholder { color:var(--muted); }
  select.di option { background:#222; }

  .ico-btn { background:transparent; border:1px solid var(--border); border-radius:7px; color:var(--text2); width:30px; height:30px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
  .ico-btn:hover { background:rgba(255,255,255,0.09); color:var(--text); }
  .ico-btn.del:hover { background:rgba(224,82,82,.14); border-color:var(--red); color:var(--red); }
  .ico-btn.play:hover { background:rgba(82,224,122,.1); border-color:var(--green); color:var(--green); }

  .btn { background:rgba(255,255,255,0.07); border:1px solid var(--border); color:var(--text); padding:8px 18px; border-radius:9px; font-size:13px; font-weight:700; cursor:pointer; transition:.2s; font-family:inherit; display:inline-flex; align-items:center; gap:7px; white-space:nowrap; }
  .btn:hover { background:rgba(255,255,255,0.13); border-color:var(--accent2); }
  .btn.danger:hover { background:rgba(224,82,82,.14); border-color:var(--red); color:var(--red); }

  .add-row-btn { width:100%; margin-top:10px; padding:10px; background:rgba(255,255,255,0.03); border:1px dashed var(--border); border-radius:9px; color:var(--text2); font-size:13px; font-weight:700; font-family:inherit; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
  .add-row-btn:hover { background:rgba(255,255,255,0.07); color:var(--text); border-color:var(--accent); }

  .info-row { display:flex; gap:10px; padding:8px 0; border-bottom:1px solid var(--border-l); font-size:13px; color:var(--text2); }
  .info-row:last-child { border-bottom:none; }
  .info-row strong { color:var(--text); min-width:140px; }

  .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:rgba(36,36,36,0.96); backdrop-filter:blur(20px); border:1px solid var(--border); color:var(--text); padding:11px 24px; border-radius:30px; font-size:14px; font-weight:700; z-index:9998; transition:transform .4s cubic-bezier(.34,1.56,.64,1); pointer-events:none; }
  .toast.show { transform:translateX(-50%) translateY(0); }

  #jsonStatus { font-size:12px; margin-top:8px; min-height:18px; }

  @keyframes up    { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }
  @keyframes spin  { to{transform:rotate(360deg)} }
  ::-webkit-scrollbar{width:5px;height:5px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.09);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.18)}

  @media(max-width:640px){
    nav{padding:0 14px;gap:10px}
    main{padding:76px 14px 40px}
    .srch-wrap{flex:0 0 150px}
    .ch-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px}
    .pl-topbar,.related-sec{padding:12px 14px}
    .dv-body{padding:14px}
  }
</style>
</head>
<body>

<div class="blobs">
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>
</div>

<div class="toast" id="toast"></div>

<nav>
  <div class="logo">
    <div class="logo-icon">üì∫</div>
    TV Chile <span>¬∑</span><span style="font-size:13px;font-weight:300">Stream</span>
  </div>
  <div class="srch-wrap">
    <svg class="srch-ico" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg>
    <input class="srch" id="srchInput" placeholder="Buscar canal‚Ä¶" oninput="filterCh()">
  </div>
  <button class="nav-pill active" id="nav-home" onclick="showView('home')">Inicio</button>
  <button class="nav-pill" id="nav-data" onclick="showView('data')">Gesti√≥n</button>
</nav>

<div id="app">

<!-- ‚ñà‚ñà‚ñà‚ñà HOME ‚ñà‚ñà‚ñà‚ñà -->
<div id="home-view" class="view active">
  <main>
    <div class="hero">
      <h1>Televisi√≥n Chilena</h1>
      <p>Todos tus canales favoritos en un solo lugar</p>
    </div>
    <div class="status-bar">
      <div class="sp"><div class="dot-r"></div>En Vivo</div>
      <div class="sp"><div class="dot-g"></div><span id="chCount">0</span> canales</div>
      <div class="sp" id="srcPill">üìÑ channels.json</div>
    </div>
    <div class="cat-tabs" id="catTabs"></div>
    <div class="sec-label" id="secLabel">Todos los canales</div>
    <div class="ch-grid" id="chGrid"></div>
    <div class="empty" id="emptyState" style="display:none">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
      <h3>Sin resultados</h3><p>Prueba con otro t√©rmino o categor√≠a</p>
    </div>
  </main>
</div>

<!-- ‚ñà‚ñà‚ñà‚ñà PLAYER ‚ñà‚ñà‚ñà‚ñà -->
<div id="player-view" class="view">
  <div class="pl-topbar">
    <button class="back-btn" onclick="showView('home')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
      Volver
    </button>
    <div><div class="pl-ch-name" id="plName"></div><div class="pl-ch-cat" id="plCat"></div></div>
    <div class="live-badge"><div class="dot-r"></div>En Vivo</div>
  </div>
  <div class="pl-box" id="plBox">
    <video id="vid" controls playsinline></video>
    <div class="pl-grad"></div>
    <div class="pl-label">
      <div class="pl-label-name" id="plLabelName"></div>
      <div class="pl-label-sub"  id="plLabelSub"></div>
    </div>
    <div class="pl-loading" id="plLoading">
      <div class="spinner"></div>
      <div style="font-size:13px;color:rgba(255,255,255,.5)">Cargando transmisi√≥n‚Ä¶</div>
    </div>
  </div>
  <div class="pl-error" id="plError"></div>
  <div class="related-sec">
    <div class="sec-label">Otros canales</div>
    <div class="ch-grid" id="relGrid"></div>
  </div>
</div>

<!-- ‚ñà‚ñà‚ñà‚ñà DATA ‚ñà‚ñà‚ñà‚ñà -->
<div id="data-view" class="view">
  <main>
    <div class="dv-wrap">
      <div class="dv-header">
        <h2>Gesti√≥n de Canales</h2>
        <p>
          Fuente: <code style="background:rgba(255,255,255,0.07);padding:2px 8px;border-radius:5px;font-size:12px;color:var(--accent2)">channels.json</code>
          ‚Äî Edita el JSON, aplica los cambios y descarga el archivo actualizado
        </p>
      </div>

      <!-- JSON EDITOR -->
      <div class="dv-card">
        <div class="dv-head">
          <h3>üìÑ Editor JSON ‚Äî channels.json</h3>
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="validateJson()">‚úì Validar</button>
            <button class="btn" onclick="applyJson()">‚Ü© Aplicar</button>
          </div>
        </div>
        <div class="dv-body">
          <textarea class="json-editor" id="jsonEditor" spellcheck="false"></textarea>
          <div id="jsonStatus" style="color:var(--text2)"></div>
          <div class="json-actions">
            <button class="btn" onclick="downloadJson()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Descargar channels.json
            </button>
            <button class="btn" onclick="document.getElementById('importFile').click()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Cargar archivo JSON
            </button>
            <button class="btn danger" onclick="resetDefaults()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
              Restaurar defaults
            </button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="loadJsonFile(this)">
          </div>
        </div>
      </div>

      <!-- VISUAL TABLE -->
      <div class="dv-card">
        <div class="dv-head">
          <h3>üóÇ Tabla Visual</h3>
          <span style="font-size:12px;color:var(--text2)">Se sincroniza con el editor JSON autom√°ticamente</span>
        </div>
        <div class="dv-body">
          <table class="ch-table">
            <thead>
              <tr>
                <th style="width:50px">Emoji</th>
                <th style="width:130px">Nombre</th>
                <th>URL M3U8</th>
                <th style="width:140px">Categor√≠a</th>
                <th style="width:72px">Acc.</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
          <button class="add-row-btn" onclick="addRow()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Agregar Canal
          </button>
        </div>
      </div>

      <!-- INFO -->
      <div class="dv-card">
        <div class="dv-head"><h3>‚ÑπÔ∏è C√≥mo usar</h3></div>
        <div class="dv-body">
          <div class="info-row"><strong>Flujo de trabajo</strong>Coloca channels.json junto al HTML ‚Üí abre con servidor HTTP ‚Üí los canales se cargan autom√°ticamente</div>
          <div class="info-row"><strong>Sin servidor</strong>Los cambios se guardan en localStorage hasta que descargues el JSON actualizado</div>
          <div class="info-row"><strong>Servidor r√°pido</strong><code style="font-size:11px;background:rgba(255,255,255,0.07);padding:2px 6px;border-radius:4px">python3 -m http.server 8080</code> o Live Server en VS Code</div>
          <div class="info-row"><strong>Motor HLS</strong>HLS.js v1.4 ‚Äî streams M3U8 est√°ndar</div>
          <div class="info-row"><strong>CORS</strong>Los streams deben tener cabeceras CORS abiertas para reproducirse en el navegador</div>
        </div>
      </div>
    </div>
  </main>
</div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ DEFAULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULTS = [
  {"id":1, "name":"TVN",       "emoji":"üîµ","url":"https://d1gb9psy75ky90.cloudfront.net/national/live/576p30/index.m3u8","cat":"Nacional"},
  {"id":2, "name":"Canal 13",  "emoji":"üü°","url":"https://live.canal13.cl/live.m3u8","cat":"Nacional"},
  {"id":3, "name":"Mega",      "emoji":"üü†","url":"https://d1x0mwiac2rqwt.cloudfront.net/5e5vl4nq4oughe4s/index.m3u8","cat":"Nacional"},
  {"id":4, "name":"CHV",       "emoji":"üî¥","url":"https://d2gg3tblxgbsh1.cloudfront.net/out/v1/5f4fe434b5454db58d2b5f31ca1c30ea/index.m3u8","cat":"Nacional"},
  {"id":5, "name":"La Red",    "emoji":"üü£","url":"https://la-red-live.amagi.tv/playlist.m3u8","cat":"Nacional"},
  {"id":6, "name":"CNN Chile", "emoji":"üóûÔ∏è","url":"https://cnnchilelive.amagi.tv/playlist.m3u8","cat":"Noticias"},
  {"id":7, "name":"24 Horas",  "emoji":"‚åö","url":"https://d1gb9psy75ky90.cloudfront.net/24horas/live/576p30/index.m3u8","cat":"Noticias"},
  {"id":8, "name":"Tele 5",    "emoji":"‚ö™","url":"https://cdn3.wowza.com/1/RTZHRFZhTFkxZU5V/bXJiST13/hls/live/playlist.m3u8","cat":"Regional"},
  {"id":9, "name":"T13 Radio", "emoji":"üìª","url":"https://playerservices.streamtheworld.com/api/livestream-redirect/T13RADIO_SC","cat":"Radio"},
  {"id":10,"name":"TV5Monde",  "emoji":"üá´üá∑","url":"https://tv5monde-hls-live.akamaized.net/hls/live/657179/fip/index.m3u8","cat":"Internacional"}
];
const CATS = ["Todos","Nacional","Noticias","Regional","Radio","Internacional"];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let channels = [];
let currentCat = "Todos";
let currentQ   = "";
let hls        = null;

// ‚îÄ‚îÄ‚îÄ INIT ‚Äî carga channels.json, si falla usa localStorage o defaults ‚îÄ
async function initApp() {
  let src = "defaults";

  // 1. fetch channels.json (requiere servidor HTTP)
  try {
    const res = await fetch('./channels.json?' + Date.now()); // cache-bust
    if (res.ok) {
      const data = await res.json();
      if (Array.isArray(data) && data.length) {
        channels = data;
        src = "json";
      }
    }
  } catch(_) {}

  // 2. localStorage
  if (src === "defaults") {
    const saved = localStorage.getItem("tvchile_channels");
    if (saved) {
      try { channels = JSON.parse(saved); src = "storage"; } catch(_) {}
    }
  }

  // 3. Defaults
  if (!channels.length) channels = JSON.parse(JSON.stringify(DEFAULTS));

  saveStorage();

  const labels = { json:"‚úì channels.json", storage:"üíæ localStorage", defaults:"‚ö†Ô∏è defaults" };
  document.getElementById("srcPill").textContent = labels[src] || "";

  renderHome();
}

function saveStorage() {
  localStorage.setItem("tvchile_channels", JSON.stringify(channels));
}

// ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showView(name) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.querySelectorAll(".nav-pill").forEach(b => b.classList.remove("active"));
  document.getElementById(name + "-view").classList.add("active");
  document.getElementById("nav-" + name)?.classList.add("active");
  if (name === "home") renderHome();
  if (name === "data") renderDataView();
  if (name !== "player") stopPlayer();
}

// ‚îÄ‚îÄ‚îÄ HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome() {
  document.getElementById("chCount").textContent = channels.length;
  // Cat tabs
  document.getElementById("catTabs").innerHTML = CATS.map(c =>
    `<button class="cat-tab ${c===currentCat?"active":""}" onclick="setCat('${c}')">${c}</button>`
  ).join("");
  renderGrid();
}

function setCat(c) { currentCat = c; renderHome(); }
function filterCh() { currentQ = document.getElementById("srchInput").value.toLowerCase(); renderGrid(); }

function getFiltered() {
  return channels.filter(ch =>
    (currentCat === "Todos" || ch.cat === currentCat) &&
    (!currentQ || ch.name.toLowerCase().includes(currentQ) || (ch.cat||"").toLowerCase().includes(currentQ))
  );
}

function renderGrid() {
  const list  = getFiltered();
  const grid  = document.getElementById("chGrid");
  const empty = document.getElementById("emptyState");
  document.getElementById("secLabel").textContent = currentCat === "Todos" ? "Todos los canales" : currentCat;
  if (!list.length) { grid.style.display="none"; empty.style.display="block"; return; }
  grid.style.display="grid"; empty.style.display="none";
  grid.innerHTML = list.map((ch,i) => `
    <div class="ch-card" style="animation-delay:${i*.04}s" onclick="playChannel(${ch.id})">
      <div class="ch-ico">${ch.emoji||"üì∫"}</div>
      <div>
        <div class="ch-name">${x(ch.name)}</div>
        <div class="ch-sub"><div class="dot-r"></div>${x(ch.cat||"")}</div>
      </div>
    </div>
  `).join("");
}

// ‚îÄ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playChannel(id) {
  const ch = channels.find(c => c.id === id);
  if (!ch) return;

  showView("player");
  document.getElementById("nav-home").classList.add("active");

  document.getElementById("plName").textContent      = ch.name;
  document.getElementById("plCat").textContent       = ch.cat||"";
  document.getElementById("plLabelName").textContent = ch.name;
  document.getElementById("plLabelSub").textContent  = ch.cat||"";

  const err  = document.getElementById("plError");
  const load = document.getElementById("plLoading");
  err.classList.remove("show");
  load.style.display = "flex";

  const vid = document.getElementById("vid");
  if (hls) { hls.destroy(); hls = null; }

  if (Hls.isSupported()) {
    hls = new Hls({ enableWorker:true, lowLatencyMode:true, backBufferLength:90 });
    hls.loadSource(ch.url);
    hls.attachMedia(vid);
    hls.on(Hls.Events.MANIFEST_PARSED, () => { load.style.display="none"; vid.play().catch(()=>{}); });
    hls.on(Hls.Events.ERROR, (_,d) => {
      if (d.fatal) {
        load.style.display = "none";
        err.textContent = "‚ö†Ô∏è No se pudo cargar la transmisi√≥n. El stream puede estar offline o bloqueado por CORS.";
        err.classList.add("show");
      }
    });
  } else if (vid.canPlayType("application/vnd.apple.mpegurl")) {
    vid.src = ch.url;
    vid.onloadedmetadata = () => { load.style.display="none"; vid.play(); };
    vid.onerror = () => { load.style.display="none"; err.textContent="‚ö†Ô∏è Error al cargar."; err.classList.add("show"); };
  } else {
    load.style.display="none"; err.textContent="‚ö†Ô∏è Navegador no compatible."; err.classList.add("show");
  }

  // Relacionados
  document.getElementById("relGrid").innerHTML = channels.filter(c=>c.id!==id).slice(0,6).map(c=>`
    <div class="ch-card" onclick="playChannel(${c.id})">
      <div class="ch-ico">${c.emoji||"üì∫"}</div>
      <div><div class="ch-name">${x(c.name)}</div><div class="ch-sub"><div class="dot-r"></div>${x(c.cat||"")}</div></div>
    </div>
  `).join("");
}

function stopPlayer() {
  const vid = document.getElementById("vid");
  if (hls) { hls.destroy(); hls = null; }
  vid.pause(); vid.src = "";
}

// ‚îÄ‚îÄ‚îÄ DATA VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDataView() {
  syncEditor();
  renderTable();
}

// JSON Editor
function syncEditor() {
  document.getElementById("jsonEditor").value = JSON.stringify(channels, null, 2);
  setStatus("");
}

function validateJson() {
  try {
    const p = JSON.parse(document.getElementById("jsonEditor").value);
    if (!Array.isArray(p)) throw new Error("Debe ser un array JSON");
    setStatus("‚úÖ JSON v√°lido ‚Äî " + p.length + " canales", "var(--green)");
  } catch(e) {
    setStatus("‚ùå " + e.message, "var(--red)");
  }
}

function applyJson() {
  try {
    const p = JSON.parse(document.getElementById("jsonEditor").value);
    if (!Array.isArray(p)) throw new Error("Debe ser un array JSON");
    channels = p;
    saveStorage();
    renderTable();
    setStatus("‚úÖ Aplicado ‚Äî " + channels.length + " canales activos", "var(--green)");
    toast("JSON aplicado ‚úì");
  } catch(e) {
    setStatus("‚ùå " + e.message, "var(--red)");
  }
}

function setStatus(msg, color="var(--text2)") {
  const el = document.getElementById("jsonStatus");
  el.textContent = msg; el.style.color = color;
}

function downloadJson() {
  const blob = new Blob([JSON.stringify(channels, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "channels.json"; a.click();
  toast("channels.json descargado ‚úì");
}

function loadJsonFile(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error();
      channels = data; saveStorage(); syncEditor(); renderTable();
      toast(data.length + " canales importados ‚úì");
    } catch { toast("‚ùå Archivo JSON inv√°lido"); }
  };
  reader.readAsText(file); input.value = "";
}

function resetDefaults() {
  channels = JSON.parse(JSON.stringify(DEFAULTS));
  saveStorage(); syncEditor(); renderTable();
  toast("Canales restaurados a defaults ‚úì");
}

// Visual table
function renderTable() {
  document.getElementById("tableBody").innerHTML = channels.map(ch => `
    <tr>
      <td><input class="di" style="text-align:center;font-size:18px;padding:4px" value="${x(ch.emoji||"")}" onchange="tblUp(${ch.id},'emoji',this.value)" maxlength="4"></td>
      <td><input class="di" value="${x(ch.name)}" onchange="tblUp(${ch.id},'name',this.value)" placeholder="Nombre"></td>
      <td><input class="di" value="${x(ch.url)}" onchange="tblUp(${ch.id},'url',this.value)" placeholder="https://...m3u8"></td>
      <td>
        <select class="di" onchange="tblUp(${ch.id},'cat',this.value)">
          ${CATS.filter(c=>c!=="Todos").map(c=>`<option value="${c}" ${ch.cat===c?"selected":""}>${c}</option>`).join("")}
        </select>
      </td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="ico-btn play" title="Reproducir" onclick="playChannel(${ch.id})">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
          </button>
          <button class="ico-btn del" title="Eliminar" onclick="delRow(${ch.id})">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
          </button>
        </div>
      </td>
    </tr>
  `).join("");
}

function tblUp(id, field, value) {
  const ch = channels.find(c => c.id === id);
  if (ch) { ch[field] = value; saveStorage(); syncEditor(); }
}

function delRow(id) {
  channels = channels.filter(c => c.id !== id);
  saveStorage(); syncEditor(); renderTable();
  toast("Canal eliminado");
}

function addRow() {
  channels.push({ id: Date.now(), name: "Nuevo Canal", emoji: "üì∫", url: "", cat: "Nacional" });
  saveStorage(); syncEditor(); renderTable();
  toast("Canal agregado ‚Äî completa los campos");
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function x(s) { return String(s).replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

let _tt;
function toast(msg) {
  const el = document.getElementById("toast");
  el.textContent = msg; el.classList.add("show");
  clearTimeout(_tt); _tt = setTimeout(() => el.classList.remove("show"), 2700);
}

// ‚îÄ‚îÄ‚îÄ GO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initApp();
</script>
</body>
</html>
